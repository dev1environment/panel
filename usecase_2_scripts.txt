										USECASE-2
								       -----------


DDL SCRIPT FOR STAGE DATASET TABLE
-------------------------------------

CREATE TABLE
  usecase2_stage.table1 ( SNAPSHOTDATE STRING,
    EMPLID STRING,
    EMPL_CLASS STRING,
    POSITION_NBR STRING,
    POSITION_DESCRIPTION STRING,
    DEPTID STRING,
    DIRECOTRATE_DESCRIPTION STRING,
    DEPARTMENT_DESCRIPTION STRING,
    ACCT_CD STRING,
    LOCATION STRING,
    ORG_LEVEL STRING,
    L1_EMPLID STRING,
    L1_NAME STRING,
    L1_POSITION_NBR STRING,
    L1_POSITION_NAME STRING,
    L2_EMPLID STRING,
    L2_NAME STRING,
    L2_POSITION_NBR STRING,
    L2_POSITION_NAME STRING,
    L3_EMPLID STRING,
    L3_NAME STRING,
    L3_POSITION_NBR STRING,
    L3_POSITION_NAME STRING,
    LEVEL STRING,
    HIRE_DATE STRING,
    REHIRE_DT STRING,
    SERVICE_DT STRING,
    SERVICE_DATE STRING);



bq load --source_format=CSV --skip_leading_rows=1 dataset.table "D:\Technologies\GCP\use_case_2\org_employee_details.csv" 


HISTORY TABLE DDL SCRIPT
---------------------------

CREATE SCHEMA usecase2_history;
 
CREATE TABLE
  usecase2_history.table1 ( SNAPSHOTDATE DATE,
    EMPLID INT64,
    EMPL_CLASS STRING,
    POSITION_NBR INT64,
    POSITION_DESCRIPTION STRING,
    DEPTID STRING,
    DIRECOTRATE_DESCRIPTION STRING,
    DEPARTMENT_DESCRIPTION STRING,
    ACCT_CD STRING,
    LOCATION STRING,
    ORG_LEVEL INT64,
    L1_EMPLID STRING,
    L1_NAME STRING,
    L1_POSITION_NBR STRING,
    L1_POSITION_NAME STRING,
    L2_EMPLID STRING,
    L2_NAME STRING,
    L2_POSITION_NBR STRING,
    L2_POSITION_NAME STRING,
    L3_EMPLID STRING,
    L3_NAME STRING,
    L3_POSITION_NBR STRING,
    L3_POSITION_NAME STRING,
    LEVEL INT64,
    HIRE_DATE DATE,
    REHIRE_DT DATE,
    SERVICE_DT DATE,
    REAL_SERVICE_DATE DATE,
    LAST_UPDATED TIMESTAMP,
    CUNTRY_CODE STRING,
    STATE_CODE STRING);




DML script for Histort table
------------------------------

INSERT INTO
  usecase2_history.table1
SELECT
  PARSE_DATE('%d-%m-%Y',SNAPSHOTDATE) AS SNAPSHOTDATE,
  safe_CAST (EMPLID AS int64) AS EMPLID,
  EMPL_CLASS STRING,
  CAST (POSITION_NBR AS int64) AS POSITION_NBR,
  POSITION_DESCRIPTION STRING,
  DEPTID STRING,
  DIRECOTRATE_DESCRIPTION STRING,
  DEPARTMENT_DESCRIPTION STRING,
  ACCT_CD STRING,
  LOCATION STRING,
  CAST (ORG_LEVEL AS int64) AS ORG_LEVEL,
  L1_EMPLID STRING,
  L1_NAME STRING,
  L1_POSITION_NBR STRING,
  L1_POSITION_NAME STRING,
  L2_EMPLID STRING,
  L2_NAME STRING,
  L2_POSITION_NBR STRING,
  L2_POSITION_NAME STRING,
  L3_EMPLID STRING,
  L3_NAME STRING,
  L3_POSITION_NBR STRING,
  L3_POSITION_NAME STRING,
  CAST (level AS int64) AS level,
  parse_date ('%Y-%m-%d',HIRE_DATE) AS HIRE_DATE,
  PARSE_DATE('%d-%m-%Y',REHIRE_DT) AS REHIRE_DT,
  PARSE_DATE('%Y-%m-%d',SERVICE_DT) AS SERVICE_DT,
  PARSE_DATE('%Y-%m-%d',SERVICE_DATE) AS REAL_SERVICE_DATE,
  current_timestamp AS LAST_UPDATED,
  "USA" AS CUNTRY_CODE,
  "NY" AS STATE_CODE
FROM
  usecase2_stage.table1
  
  
  
TO create view
---------------

1) 
CREATE VIEW
  usecase2_view.view1 AS
SELECT
  *
FROM
  usecase2_history.table1;



2) 
CREATE VIEW
  usecase2_view.view2 AS
SELECT
  SNAPSHOTDATE,
  EMPLID,
  EMPL_CLASS,
  POSITION_NBR,
  POSITION_DESCRIPTION,
  DEPTID,
  DIRECOTRATE_DESCRIPTION,
  DEPARTMENT_DESCRIPTION,
  ACCT_CD,
  LOCATION,
  ORG_LEVEL,
  L1_EMPLID,
  L1_NAME,
  L1_POSITION_NBR,
  L1_POSITION_NAME,
  L2_EMPLID,
  L2_NAME,
  L2_POSITION_NBR,
  L2_POSITION_NAME,
  L3_EMPLID,
  L3_NAME,
  L3_POSITION_NBR,
  L3_POSITION_NAME,
  LEVEL,
  HIRE_DATE
FROM 
  usecase2_history.table1;
  
  
AUDIT TABLE SCRIPT
-------------------

CREATE TABLE
  project-0039-384911.usecase2_audit.usecase2_history.table1 ( DATASETNAME STRING,
    TABLENAME STRING,
    AUDIT_DATE TIMESTAMP,
    TOTAL_RECORDS_PROCESSED INT64,
    AUDITOR STRING);


INSERT INTO
  usecase2_audit.usecase2_stage.table1
SELECT
  'HISTORY_DATASET' AS DATASET,
  'HISTORY_TABLE' AS TABLE,
  CURRENT_TIMESTAMP AS AUDIT_DATE,
  COUNT(*) AS TOTAL_RECORDS_PROCESSED,
  '3993' AS AUDITOR
FROM
  usecase2_history.table1;
  

INSERT INTO
  usecase2_audit.table1
SELECT
  'STAGE_DATASET' AS DATASET,
  'STAGE_TABLE' AS TABLE,
  CURRENT_TIMESTAMP AS AUDIT_DATE,
  COUNT(*) AS TOTAL_RECORDS_PROCESSED,
  '3993' AS AUDITOR
FROM
  usecase2_stage.table1;
  
  

Partition table while creating value
--------------------------------------

  CREATE TABLE
  usecase2_history.partition_table1 ( SNAPSHOTDATE DATE,
    EMPLID INT64,
    EMPL_CLASS STRING,
    POSITION_NBR INT64,
    POSITION_DESCRIPTION STRING,
    DEPTID STRING,
    DIRECOTRATE_DESCRIPTION STRING,
    DEPARTMENT_DESCRIPTION STRING,
    ACCT_CD STRING,
    LOCATION STRING,
    ORG_LEVEL INT64,
    L1_EMPLID STRING,
    L1_NAME STRING,
    L1_POSITION_NBR STRING,
    L1_POSITION_NAME STRING,
    L2_EMPLID STRING,
    L2_NAME STRING,
    L2_POSITION_NBR STRING,
    L2_POSITION_NAME STRING,
    L3_EMPLID STRING,
    L3_NAME STRING,
    L3_POSITION_NBR STRING,
    L3_POSITION_NAME STRING,
    LEVEL INT64,
    HIRE_DATE DATE,
    REHIRE_DT DATE,
    SERVICE_DT DATE,
    REAL_SERVICE_DATE DATE,
    LAST_UPDATED TIMESTAMP,
    CUNTRY_CODE STRING,
    STATE_CODE STRING)
PARTITION BY
  timestamp_trunc(LAST_UPDATED,day);


